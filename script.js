var pins = [
  {
    "category": "Graffiti",
    "title": "S Lies",
    "coords": {
      "x": "64.76746506986028%",
      "y": "57.44876912840985%"
    },
    "pinImg": "https://assets.codepen.io/1533917/fried-egg.png",
    "dataImg": "https://mywikis-eu-wiki-media.s3.eu-central-2.wasabisys.com/thefinals/20230616171309_1.jpg"
  },
  {
    "category": "Graffiti",
    "title": "SR.!",
    "coords": {
      "x": "59.33333333333333%",
      "y": "73.8888888888889%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787235345170432/graffiti.png?ex=6629acf8&is=661737f8&hm=e1f7f24be97a3035e90131dd4f39f860bd0b750d2d78c52bcf5e03f185cb2509&",
    "dataImg": "https://mywikis-eu-wiki-media.s3.eu-central-2.wasabisys.com/thefinals/SRspray.jpg"
  },
  {
    "category": "Graffiti",
    "title": "825c",
    "coords": {
      "x": "62.77777777777777%",
      "y": "51.95444444444445%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787235345170432/graffiti.png?ex=6629acf8&is=661737f8&hm=e1f7f24be97a3035e90131dd4f39f860bd0b750d2d78c52bcf5e03f185cb2509&",
    "dataImg": "https://mywikis-eu-wiki-media.s3.eu-central-2.wasabisys.com/thefinals/825.png"
  },
  {
    "category": "Graffiti",
    "title": "1339c",
    "coords": {
      "x": "29.11111111111111%",
      "y": "29.777777777777775%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787235345170432/graffiti.png?ex=6629acf8&is=661737f8&hm=e1f7f24be97a3035e90131dd4f39f860bd0b750d2d78c52bcf5e03f185cb2509&",
    "dataImg": "https://mywikis-eu-wiki-media.s3.eu-central-2.wasabisys.com/thefinals/1339c.png"
  },
  {
    "category": "Statues",
    "title": "Fountain East",
    "coords": {
      "x": "81.44444444444444%",
      "y": "44.63888888888889%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227786563946283131/sculpture.png?ex=6629ac58&is=66173758&hm=eeedd3673f92be132b7abd5cdfa37ba3d9a251afad1e905a21f308be2ccdbfa4&",
    "dataImg": ""
  },
  {
    "category": "Statues",
    "title": "Fountain West",
    "coords": {
      "x": "10.059633027522937%",
      "y": "37.69806684141546%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227786563946283131/sculpture.png?ex=6629ac58&is=66173758&hm=eeedd3673f92be132b7abd5cdfa37ba3d9a251afad1e905a21f308be2ccdbfa4&",
    "dataImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227782477058412585/image.png?ex=6629a889&is=66173389&hm=1b45dacc290191c48038d22db26f82514664661ac20a359f2918d93f3aa8d132&"
  },
  {
    "category": "Diamonds",
    "title": "Oval with crown",
    "coords": {
      "x": "22.379423328964613%",
      "y": "41.21051769331586%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787524643225642/poker.png?ex=6629ad3d&is=6617383d&hm=a0d53e4b8ecf993dc85fb72493fe171c1b389e767fcc4788d90b47d632c7c4ea&",
    "dataImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227782995692228710/image.png?ex=6629a905&is=66173405&hm=5d1184a4062534a526251c51af92e0c5fa2695b2eab96adee69d2c31d9604ed2&"
  },
  {
    "category": "Diamonds",
    "title": "Sign Post",
    "coords": {
      "x": "24.63368283093054%",
      "y": "28.418905635648755%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787524643225642/poker.png?ex=6629ad3d&is=6617383d&hm=a0d53e4b8ecf993dc85fb72493fe171c1b389e767fcc4788d90b47d632c7c4ea&://assets.codepen.io/1533917/rabbit.png",
    "dataImg": ""
  },
  {
    "category": "Statues",
    "title": "Lady 01 West",
    "coords": {
      "x": "18.631061598951508%",
      "y": "27.396625163827%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227786563946283131/sculpture.png?ex=6629ac58&is=66173758&hm=eeedd3673f92be132b7abd5cdfa37ba3d9a251afad1e905a21f308be2ccdbfa4&",
    "dataImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227784091219263488/image.png?ex=6629aa0a&is=6617350a&hm=7e74f441e6be794b441be8b74e283ab42f130812999f7690215c55d5156655a2&"
  },
  {
    "category": "Cannons",
    "title": "NW 1",
    "coords": {
      "x": "13.991480996068152%",
      "y": "25.771461336828306%"
    },
    "pinImg": "https://cdn.discordapp.com/attachments/1227782293129793656/1227787011881173022/cannon.png?ex=6629acc2&is=661737c2&hm=5d03d04290e63a550a5d3eb8ae6a0af2fd7b3fbd608d9af16bdfde477f8f8f8f&",
    "dataImg": ""
  }
];

function createPin(pin) {
    var pinElement = document.createElement('div');
    pinElement.classList.add('pin');
    pinElement.style.left = pin.coords.x;
    pinElement.style.top = pin.coords.y;
    pinElement.title = pin.title;

    var pinImage = document.createElement('img');
    pinImage.src = pin.pinImg; // Use pinImg property for pin image
    pinImage.alt = pin.title;

    var popup = createPopup(pin);

    pinElement.appendChild(pinImage);
    pinElement.appendChild(popup);
    document.getElementById('map').appendChild(pinElement);

    pinElement.addEventListener('mouseenter', function() {
        popup.classList.add('active');
    });

    pinElement.addEventListener('mouseleave', function() {
        popup.classList.remove('active');
    });

    pinElement.addEventListener('click', function() {
        togglePopup(popup);
        updateSidebar(); // Update the sidebar when pin visibility changes
    });
}

function togglePopup(popup) {
    popup.classList.toggle('active');
}

function createPopup(pin) {
    var popup = document.createElement('div');
    popup.classList.add('popup');

    var pinData = document.createElement('div');
    pinData.innerHTML = '<strong>Category:</strong> ' + pin.category + '<br>' +
                     '<strong>Title:</strong> ' + pin.title + '<br>' +
                     '<strong>Image:</strong> <img src="' + pin.dataImg + '" style="">';

    popup.appendChild(pinData);

    return popup;
}


function deletePin(pin) {
    var index = pins.indexOf(pin);
    if (index !== -1) {
        pins.splice(index, 1);
        clearMap();
        loadPins();
        updateSidebar();
    }
}

function updateSidebar() {
    var sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = ''; // Clear previous content

    var categories = {}; // Object to store pins by category

    pins.forEach(function(pin) {
        if (!categories[pin.category]) {
            categories[pin.category] = [];
        }
        categories[pin.category].push(pin);
    });

    for (var category in categories) {
        var categoryHeader = document.createElement('h3');
        categoryHeader.textContent = category;
        sidebar.appendChild(categoryHeader);

        categories[category].forEach(function(pin) {
            var pinCheckbox = document.createElement('input');
            pinCheckbox.type = 'checkbox';
            pinCheckbox.checked = true; // By default, pins are visible
            pinCheckbox.addEventListener('change', function() {
                var pinElement = document.querySelector('.pin[title="' + pin.title + '"]');
                pinElement.style.display = this.checked ? 'block' : 'none';
            });

            var pinLabel = document.createElement('label');
            pinLabel.textContent = pin.title;
            pinLabel.style.cursor = 'pointer';
            pinLabel.addEventListener('click', function() {
                var pinElement = document.querySelector('.pin[title="' + pin.title + '"]');
                var popup = pinElement.querySelector('.popup');
                togglePopup(popup);
                showPinEdit(pin, sidebar);
            });

            var pinItem = document.createElement('div');
            pinItem.appendChild(pinCheckbox);
            pinItem.appendChild(pinLabel);
            sidebar.appendChild(pinItem);
        });
    }
}

function showPinEdit(pin, sidebar) {
    var editMode = document.getElementById('editMode');
    editMode.innerHTML = `
        <div id="editPin">
            <h3>Editting Map Pin: ${pin.category} - ${pin.title}</h3>
            <label for="editCategory">Category:</label>
            <input type="text" id="editCategory" value="${pin.category}"><br>
            <label for="editTitle">Title:</label>
            <input type="text" id="editTitle" value="${pin.title}"><br>
            <label for="editCoordsX">Coordinates (X):</label>
            <input type="text" id="editCoordsX" value="${pin.coords.x}"><br>
            <label for="editCoordsY">Coordinates (Y):</label>
            <input type="text" id="editCoordsY" value="${pin.coords.y}"><br>
            <label for="editPinImg">Pin Image URL:</label>
            <input type="text" id="editPinImg" value="${pin.pinImg}"><br>
            <label for="editDataImg">Data Image URL:</label>
            <input type="text" id="editDataImg" value="${pin.dataImg}"><br>
            <button onclick="savePinEdit(${pins.indexOf(pin)})">Save & Close</button>
            <button onclick="deletePin(${pins.indexOf(pin)})">Delete</button>
        </div>`;
}

function deletePin(index) {
    if (confirm("Are you sure you want to delete this pin?")) {
        pins.splice(index, 1);
        updateSidebar();
        clearMap(); // Clear existing pins from the map
        loadPins(); // Reload pins onto the map after deletion
    }
}


function savePinEdit(index) {
    var editCategory = document.getElementById('editCategory').value;
    var editTitle = document.getElementById('editTitle').value;
    var editCoordsX = document.getElementById('editCoordsX').value;
    var editCoordsY = document.getElementById('editCoordsY').value;
    var editPinImg = document.getElementById('editPinImg').value;
    var editDataImg = document.getElementById('editDataImg').value;

    if (!editCategory || !editTitle) {
        alert("Category and Title cannot be empty!");
        return;
    }

    pins[index].category = editCategory;
    pins[index].title = editTitle;
    pins[index].coords.x = editCoordsX;
    pins[index].coords.y = editCoordsY;
    pins[index].pinImg = editPinImg;
    pins[index].dataImg = editDataImg;

    updateSidebar();
    clearMap(); // Clear existing pins from the map
    loadPins(); // Reload pins onto the map after modification

    // Clear editMode div
    document.getElementById('editMode').innerHTML = '';
}



function addPin(event) {
    var category = prompt('Enter the category for the new pin:');
    
    // Check if category is null or blank
    if (!category) {
        return; // Exit function without creating pin
    }
    
    var title = prompt('Enter the title for the new pin:');
    var dataImg = prompt('Enter the data image URL for the new pin (optional):');
    var coords = getCoordsFromClick(event);
    
    // Check if title is null or blank
    if (!title) {
        return; // Exit function without creating pin
    }
    
    var pin = {category: category, title: title, coords: coords, pinImg: 'https://assets.codepen.io/1533917/fried-egg.png', dataImg: dataImg};
    pins.push(pin);
    createPin(pin);
    updateSidebar();
}



function getCoordsFromClick(event) {
    var map = document.getElementById('map');
    var rect = map.getBoundingClientRect();
    var pinSize = 3; // Adjust based on pin size
    var x = ((event.clientX - rect.left) / map.offsetWidth * 100) - (pinSize / 2) + '%';
    var y = ((event.clientY - rect.top) / map.offsetHeight * 100) - (pinSize / 2) + '%';
    return {x: x, y: y};
}

function loadPinsFromFile(file) {
    var reader = new FileReader();
    reader.onload = function(event) {
        var loadedPins = JSON.parse(event.target.result);
        pins = loadedPins;
        clearMap(); // Clear existing pins from the map
        loadPins(); // Load newly loaded pins onto the map
    };
    reader.readAsText(file);
}

function clearMap() {
    var map = document.getElementById('map');
    map.innerHTML = ''; // Clear all child elements (pins) from the map
}

function savePinsToFile() {
    var json = JSON.stringify(pins, null, 2);
    var blob = new Blob([json], {type: "application/json"});
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.style.display = 'none';
    document.body.appendChild(a);
    a.href = url;
    a.download = "pins.json";
    a.click();
    window.URL.revokeObjectURL(url);
}

function loadPins() {
    pins.forEach(function(pin) {
        createPin(pin);
    });
    updateSidebar();
}

window.onload = function() {
    document.getElementById('loadButton').addEventListener('click', function() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            var file = event.target.files[0];
            if (file) {
                loadPinsFromFile(file);
            }
        };
        input.click();
    });

    document.getElementById('saveButton').addEventListener('click', savePinsToFile);
    document.getElementById('map').addEventListener('click', addPin);
    loadPins();
};

document.getElementById('sidebarToggle').addEventListener('click', function() {
    var sidebar = document.getElementById('sidebar');
    sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
});

// Add event listener to the optionsToggle button
document.getElementById('optionsToggle').addEventListener('click', function() {
    var optionsBar = document.getElementById('optionsBar');
    // Toggle the display style of the optionsBar between 'block' and 'none'
    optionsBar.style.display = optionsBar.style.display === 'none' ? 'block' : 'none';
});